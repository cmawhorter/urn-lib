name: Publish

# must be node v24 per this comment? https://github.com/npm/cli/issues/8730#issuecomment-3657780285
# ...i've tried everything else
env:
  NODE_VERSION: 24

on:
  release:
    types: [published]

permissions:
  contents: read
  id-token: write  # Required for OIDC authentication

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: https://registry.npmjs.org/
      # Log versions
      - run: npm --version; node --version
      - run: echo "PKG_VERSION=$(jq -r .version package.json)" >> $GITHUB_ENV
      # Assert release tag version matches the version we're publishing
      # NOTE: release tags **must** start with a lowercase "v" and then version
      - run: |
          if [ "v${{env.PKG_VERSION}}" != "${{ github.event.release.tag_name }}" ]; then
            echo '::error::Error! Package version "v${{env.PKG_VERSION}}" does not match tag version "${{ github.event.release.tag_name }}"'
            exit 1
          fi
      - run: echo '::notice::Publishing version - ${{env.PKG_VERSION}}'
      - run: npm ci
      - run: npm publish
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-files
          path: dist/
          retention-days: 90
      - name: Verify publication
        run: |
          PACKAGE_VERSION=$(jq -r .version package.json)
          sleep 10  # Wait for npm to update
          PUBLISHED_VERSION=$(npm view urn-lib version)

          if [ "$PACKAGE_VERSION" = "$PUBLISHED_VERSION" ]; then
            echo "::notice::Successfully published version $PUBLISHED_VERSION"
          else
            echo "::warning::Published version check inconclusive"
          fi
